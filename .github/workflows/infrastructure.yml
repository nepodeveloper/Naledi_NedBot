name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'naledi_nedbot/infra/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  LOGIC_APP_NAME: 'nedbot-logic-app'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read   # Required for repo access

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Install Azure CLI Bicep extension
        run: az bicep install

      - name: Create Resource Group if not exists
        run: |
          if ! az group show --name ${{ secrets.AZURE_RG }} &>/dev/null; then
            az group create --name ${{ secrets.AZURE_RG }} --location ${{ vars.AZURE_REGION || 'southafricanorth' }}
          fi

      - name: Validate Bicep template
        run: |
          az deployment group validate \
            --resource-group ${{ secrets.AZURE_RG }} \
            --template-file naledi_nedbot/infra/logic-app.bicep \
            --parameters \
              location=${{ vars.AZURE_REGION || 'southafricanorth' }} \
              logicAppName=${{ env.LOGIC_APP_NAME }} \
              apiBaseUrl=${{ secrets.API_BASE_URL }} \
              apiKeyValue=${{ secrets.API_KEY_VALUE }} \
              environment=${{ github.event.inputs.environment || 'dev' }}

      - name: Deploy Bicep infrastructure
        run: |
          az deployment group create \
            --resource-group ${{ secrets.AZURE_RG }} \
            --template-file naledi_nedbot/infra/logic-app.bicep \
            --parameters \
              location=${{ vars.AZURE_REGION || 'southafricanorth' }} \
              logicAppName=${{ env.LOGIC_APP_NAME }} \
              apiBaseUrl=${{ secrets.API_BASE_URL }} \
              apiKeyValue=${{ secrets.API_KEY_VALUE }} \
              environment=${{ github.event.inputs.environment || 'dev' }} \
            --mode Incremental

      - name: Get deployment outputs
        id: deployment-outputs
        run: |
          logicAppId=$(az deployment group show \
            --resource-group ${{ secrets.AZURE_RG }} \
            --name logic-app \
            --query properties.outputs.logicAppResourceId.value -o tsv)
          echo "logic-app-id=$logicAppId" >> $GITHUB_OUTPUT

      - name: Enable Logic App
        run: |
          az logic workflow update \
            --resource-group ${{ secrets.AZURE_RG }} \
            --name ${{ env.LOGIC_APP_NAME }} \
            --state Enabled

      - name: Deployment Summary
        run: |
          echo "âœ… Infrastructure Deployment Complete"
          echo "====================================="
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Resource Group: ${{ secrets.AZURE_RG }}"
          echo "Logic App: ${{ env.LOGIC_APP_NAME }}"
          echo "Storage Account: ${{ steps.deployment-outputs.outputs.storage-account-name }}"
          echo ""
          echo "ðŸ“Š Blob Storage Containers:"
          echo "  - email-attachments (for PDF attachments)"
          echo "  - processed-pdfs (for processed documents)"
          echo "  - transaction-data (for transaction records)"
          echo "  - processed-emails (for duplicate detection)"
          echo ""
          echo "ðŸ”— HTTP Trigger Endpoint:"
          echo "Test the Logic App by sending HTTP POST requests to the trigger URL"
          echo ""
          echo "ðŸ“Š Next Steps:"
          echo "1. Get the HTTP trigger URL from Azure Portal"
          echo "2. Send test payloads using Postman or curl"
          echo "3. Monitor Logic App runs in Azure Portal"
          echo "4. Check Application Insights for detailed logs"
          echo "5. View transaction data in blob storage"
          echo "6. Verify HTTP responses are returned correctly"
          echo "7. Test webhook callback if using callbackUrl parameter"