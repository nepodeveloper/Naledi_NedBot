name: Deploy Java App to Azure

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Naledi-Nedbot-API/**'
      - '.github/workflows/java-app-deploy.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'Naledi-Nedbot-API/**'
      - '.github/workflows/java-app-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

permissions:
  contents: read
  id-token: write # Required for OIDC

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: |
        cd Naledi-Nedbot-API
        chmod +x mvnw
        ./mvnw clean package
        
    - name: Login to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Create App Service if not exists
      run: |
        echo "Creating/updating App Service Plan and Web App..."
        
        # Create resource group if it doesn't exist
        if ! az group show --name ${{ secrets.AZURE_RG }} &>/dev/null; then
          az group create --name ${{ secrets.AZURE_RG }} --location ${{ vars.AZURE_REGION || 'eastus' }}
        fi
        
        # Create App Service Plan if it doesn't exist
        PLAN_NAME="nedbot-app-plan"
        if ! az appservice plan show --name $PLAN_NAME --resource-group ${{ secrets.AZURE_RG }} &>/dev/null; then
          az appservice plan create \
            --name $PLAN_NAME \
            --resource-group ${{ secrets.AZURE_RG }} \
            --sku B1 \
            --is-linux \
            --location "southafricanorth"
        fi
        
        # Create Web App if it doesn't exist
        APP_NAME="nedbot-app"
        if ! az webapp show --name $APP_NAME --resource-group ${{ secrets.AZURE_RG }} &>/dev/null; then
          az webapp create \
            --name $APP_NAME \
            --resource-group ${{ secrets.AZURE_RG }} \
            --plan $PLAN_NAME \
            --runtime "JAVA:17-java17"
        fi
        
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: nedbot-app
        package: Naledi-Nedbot-API/target/*.jar
        
    - name: Configure App Settings
      run: |
        az webapp config appsettings set \
          --name nedbot-app \
          --resource-group ${{ secrets.AZURE_RG }} \
          --settings \
            SPRING_PROFILES_ACTIVE=${{ github.event.inputs.environment || 'dev' }} \
            WEBSITES_PORT=8080